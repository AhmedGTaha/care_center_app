rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Allow authenticated users to read their own data and write their own data.
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // TEMPORARY: allow everything during development
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
  match /databases/{database}/documents {
    
    // Users collection - only authenticated users can read/write their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null; // Allow authenticated users to read other users' data
    }
    
    // Equipment collection - Public READ access (for guests), admin WRITE
    match /equipment/{equipmentId} {
      // Anyone can read equipment (including guests)
      allow read: if true;
      
      // Only authenticated users can write
      allow write: if request.auth != null;
    }
    
    // Reservations collection - User-specific access
    match /reservations/{reservationId} {
      // Users can read their own reservations
      allow read: if request.auth != null && 
                     (request.auth.uid == resource.data.userId || 
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin");
      
      // Users can create reservations
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      
      // Only admins can update/delete
      allow update, delete: if request.auth != null && 
                               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
    }
    
    // Donations collection - ALLOW ALL ACCESS (guests can create)
    match /donations/{donationId} {
      // Anyone can create donations (including unauthenticated guests)
      allow create: if true;
      
      // Anyone can read donations
      allow read: if true;
      
      // Only authenticated admins can update/delete donations
      allow update, delete: if request.auth != null && 
                               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
    }
    
    // Notifications collection - User-specific access
    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // System can create notifications (authenticated only)
      allow create: if request.auth != null;
      
      // Users can update their own notifications (mark as read)
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Only admins can delete
      allow delete: if request.auth != null && 
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
    }
  }
}
